---
title: "Azure Rights Management コネクタを監視する | Azure Information Protection"
description: "Azure Information Protection からコネクタと組織の Azure Rights Management サービスの使用を監視するのに役立つ情報です。"
author: cabailey
ms.author: cabailey
manager: mbaldwin
ms.date: 11/29/2016
ms.topic: article
ms.prod: 
ms.service: information-protection
ms.technology: techgroup-identity
ms.assetid: 8a1b3e54-f788-4f84-b9d7-5d5079e50b4e
ms.reviewer: esaggese
ms.suite: ems
translationtype: Human Translation
ms.sourcegitcommit: e5939bb469af198a74d81724c5417eb63db7732b
ms.openlocfilehash: bf73a79218fa8dba2b90115d0c1573a29f791023


---

# <a name="monitor-the-azure-rights-management-connector"></a>Azure Rights Management コネクタを監視する

>*適用対象: Azure Information Protection、Windows Server 2012、Windows Server 2012 R2*

RMS コネクタをインストールして構成した後、以下の方法と情報を使用すると、Azure Information Protection からコネクタと組織の Azure Rights Management サービスの使用を監視するのに役立ちます。

## <a name="application-event-log-entries"></a>アプリケーション イベント ログ エントリ

RMS コネクタは、アプリケーション イベント ログを使用して、**Microsoft RMS コネクタ**のエントリを記録します。 

たとえば、ID 1000 などの情報イベントは、コネクタ サービスが開始したことを示します。ID 1002 はサーバーが正常に RMS コネクタに接続したことを示し、ID 1004 は承認されたアカウントのリスト (各アカウントがリストに含まれる) がコネクタにダウンロードされたことをそのたびに示します。 

HTTPS を使用するようにコネクタを構成していない場合は、クライアントがセキュリティで保護されていない (HTTP) 接続を使用していることを示す警告 ID 2002 が表示されます。

コネクタが Azure Rights Management サービスへの接続に失敗した場合は、通常、エラー 3001 が表示されます。 たとえば、その原因として、DNS の問題や、RMS コネクタを実行している 1 つ以上のサーバーでインターネットにアクセスできないことが考えられます。 

> [!TIP]
> RMS コネクタ サーバーが Azure Rights Management サービスに接続できない場合、その理由の多くが Web プロキシの構成によるものです。

詳細については、すべてのイベント ログ エントリと同様に、メッセージも詳しく調べてください。

初めてコネクタをデプロイするときは、イベント ログを確認するだけでなく、警告やエラーも継続的に確認してください。 たとえば、当初はコネクタが期待どおりに動作していても、依存する構成を他の管理者が変更してしまう可能性があります。 たとえば、他の管理者が Web プロキシ サーバー構成を変更したために RMS コネクタ サーバーがインターネットにアクセスできなくなったり (エラー 3001)、コネクタの使用を承認されているグループからコンピューター アカウントを削除してしまったりすることがあります (警告 2001)。

### <a name="event-log-ids-and-descriptions"></a>イベント ログ ID と説明

次のセクションでは、可能性のあるイベント ID、説明、およびその他の情報を特定できます。

-----

情報 **1000**

**Microsoft RMS コネクタの Web サービスが開始しました。**

このイベントは、RMS コネクタが最初に起動しようとしたときに記録されます。

----

情報 **1001**

**Microsoft RMS コネクタ Web サービスが停止しました。**

このイベントは、通常の操作の結果として、RMS コネクタが停止したときに記録されます。 たとえば、IIS が再起動したか、コンピューターがシャットダウンされた場合などです。 

----

情報 **1002**

**承認されたサーバーのみが Microsoft RMS コネクタにアクセスできます。**

このイベントは、オンプレミス サーバーのアカウントが RMS コネクタの管理者ツールで Azure RMS 管理者によって承認された後、初めて RMS コネクタに接続されたときに記録されます。 SID、アカウント名、接続を行っているコンピューターの名前がイベント メッセージに含まれます。

----

情報 **1003**

**以下に示すクライアントからの接続が、セキュリティで保護されていない (HTTP) 接続から、セキュリティで保護された (HTTPS) 接続に切り替わりました。**

このイベントは、オンプレミス サーバーから RMS コネクタへの接続が HTTP (安全性が低い) から HTTPS (安全性が高い) に変更されたときに記録されます。 SID、アカウント名、接続を行っているコンピューターの名前がイベント メッセージに含まれます。

----

情報 **1004**

**承認されたアカウントの一覧が更新されました。**

このイベントは、RMS コネクタの使用が承認されているアカウントの最新の一覧 (既存のアカウントとすべての変更) を RMS コネクタがダウンロードしたときに記録されます。 RMS コネクタが Azure Rights Management サービスと通信できる場合、この一覧は 15 分ごとにダウンロードされます。

----

警告 **2000**

**HTTP コンテキストにユーザー プリンシパルがないか、無効です。Microsoft RMS コネクタ Web サイトで、IIS の匿名認証が無効にされ、Windows 認証だけが有効にされていることを確認してください。**

このイベントは、RMS コネクタに接続しようとしているアカウントを RMS コネクタが一意に識別できないときに記録されます。 これは、IIS の匿名認証が正しく構成されていないか、アカウントが信頼されていないフォレストのものであることが原因である可能性があります。

----

警告 **2001**

**Microsoft RMS コネクタへの承認されていないアクセス試行です。**

このイベントは、アカウントが RMS コネクタに接続しようとして失敗したときに記録されます。 この警告の最も一般的な理由は、RMS コネクタが Azure Rights Management サービスからダウンロードする承認されたアカウントの一覧に、接続を行うアカウントが含まれていないことです。 たとえば、最新の一覧がまだダウンロードされていない (ダウンロードは 15 分ごとに発生します) か、アカウントが一覧に含まれていません。 

RMS コネクタを使用するように構成されているサーバーと同じサーバーにそのコネクタをインストールしたことが原因である場合もあります。 たとえば、Exchange Server を実行するサーバーに RMS コネクタをインストールして、Exchange アカウントにそのコネクタを使用することを承認したとします。 しかし、この構成はサポートされません。RMS コネクタが接続を試みてもアカウントを正しく識別できないためです。

イベント メッセージには、RMS コネクタに接続しようとしているアカウントとコンピューターに関する情報が含まれています。

- RMS コネクタに接続しようとしているアカウントが有効なアカウントである場合は、RMS コネクタ管理者ツールを使用して、承認されたアカウントの一覧にそのアカウントを追加します。 承認が必要なアカウントの詳細については、「[許可されたサーバーの一覧へのサーバーの追加](install-configure-rms-connector.md#add-a-server-to-the-list-of-allowed-servers)」を参照してください。 

- RMS コネクタに接続しようとしているアカウントが RMS コネクタのサーバーと同じコンピューターのものである場合は、コネクタを別のサーバーにインストールします。 コネクタの前提条件の詳細については、「[RMS コネクタの前提条件]( deploy-rms-connector.md#prerequisites-for-the-rms-connector)」を参照してください。

----

警告 **2002**

**次の一覧に示すクライアントからの接続で、セキュリティで保護されていない (HTTP) 接続が使用されています。**

このイベントは、オンプレミスのサーバーが RMS コネクタに接続できるものの、その接続で HTTPS (安全性が高い) ではなく HTTP (安全性が低い) を使用しているときに記録されます。 接続ごとではなく、アカウントごとに 1 つのイベントが記録されます。 このイベントは、アカウントが HTTPS を使用するように切り替えられたものの、HTTP に戻った場合、再度トリガーされます。

イベント メッセージには、アカウントの SID、アカウント名、RMS コネクタへの接続を行うコンピューターの名前が含まれています。

HTTPS 接続用の RMS コネクタを構成する方法については、「[HTTPS を使用するための RMS コネクタの構成](install-configure-rms-connector.md#configuring-the-rms-connector-to-use-https)」を参照してください。

----

警告 **2003**

**承認の一覧が空です。サービスは、コネクタ用に承認されたユーザーとグループの一覧が設定されるまで、使用できません。**

このイベントは、承認されたアカウントの一覧が RMS コネクタに含まれていないため、オンプレミスのサーバーが接続できないときに記録されます。 RMS コネクタは、Azure RMS から一覧を 15 分ごとにダウンロードします。 

アカウントを指定するには、RMS コネクタ管理者ツールを使用します。 詳細については、「[RMS コネクタを使用するサーバーの承認]( install-configure-rms-connector.md#authorizing-servers-to-use-the-rms-connector)」を参照してください。 

----

エラー **3000**

**Microsoft RMS コネクタで未処理の例外が発生しました。**

このイベントは、RMS コネクタで予期しないエラーが発生するたびに記録されます。エラーの詳細はイベント メッセージに含まれています。

イベント メッセージ内に **「空の応答によってリクエストが失敗しました」** というテキストがあるかどうかを確認することで、考えられる原因の 1 つを特定できます。 このテキストが見つかった場合、オン プレミス サーバーと RMS コネクタ サーバー間に、パケットの SSL 検査を実行しているネットワーク デバイスが存在する可能性あります。 これはサポートされていないため、通信に失敗し、前述のイベントログ メッセージが発生します。

----

エラー **3001**

**認証情報のダウンロード中に例外が発生しました。**

このイベントは、RMS コネクタの使用が承認されているアカウントの最新の一覧と、エラーの詳細が含まれるイベント メッセージを RMS コネクタがダウンロードできないときに記録されます。



----

## <a name="performance-counters"></a>パフォーマンス カウンター

RMS コネクタをインストールすると、**Microsoft Rights Management コネクタ**のパフォーマンス カウンターが自動的に作成されます。これらは、コネクタ経由での Azure Rights Management サービスの使用のパフォーマンスを監視するために便利です。 たとえば、ドキュメントや電子メールを保護しているとき、または保護されているドキュメントや電子メールを開いているときに頻繁に遅延が発生する場合は、パフォーマンス カウンターを調べると、遅延の原因がコネクタでの処理時間であるか、Azure Rights Management サービスでの処理時間であるか、ネットワーク遅延であるかを判断できます。 遅延が発生している場所を特定するには、**コネクタの処理時間**、**サービス応答時間**、および**コネクタ応答時間**の平均カウントが含まれているカウンターを調べます。 例: **Licensing Successful Batched Request Average Connector Response Time**。

コネクタを使用する新しいサーバー アカウントを最近追加した場合、確認するとよいカウンターは、**Time since last authorization policy update** です。リストの更新後にコネクタがリストをダウンロードしたことや、もう少し待機する必要があるかどうか (最大 15 分) を確認できます。

## <a name="rms-analyzer"></a>RMS アナライザー

このツールには現状でもサポート機能がありますが、Rights Management Serviceのアナライザー ツールを使用すると、コネクタの正常性を監視し、構成の問題を特定できます。 このツールをまだダウンロードしていない場合は、[ダウンロード センター](https://www.microsoft.com/en-us/download/details.aspx?id=46437)から入手できます。 

そのワークロードのコネクタの使用が許可されたアカウントを使用して、RMS コネクタ用に構成したサーバーのいずれかにサインインします。 たとえば、Exchange 用に RMS コネクタを構成した場合、RMS コネクタの構成ツールで Exchange 用に承認したアカウントのいずれかを使用して、そのサーバーにサインインします。 次に、**[管理者として実行]** オプションを選択し、RMS アナライザー ツールを実行します。

ツールを読み込んだら、**[ようこそ]** ページで **[Azure RMS コネクタ]** オプションを選択します。 RMS コネクタの URL をアクティブなアドレスとして入力し、緑色の矢印をクリックします。 テナントの詳細が表示されると、コネクタが Azure Rights Management サービスに正常に接続できることが確認されます。 この最初のテストが失敗した場合は、プロキシ サーバーの構成とサーバーのトラフィックを妨げている可能性があるファイアウォールを確認します。 テナントの詳細が正常に表示されたら、続いてそのサーバーのワークロードの診断テストを実行し、サポートされているバージョン番号、前提条件、およびレジストリ設定などを確認できます。

その他の情報と手順については、ダウンロード ページの **[詳細]** と **[インストール手順]** を参照してください。

## <a name="logging"></a>ログ記録

使用状況ログ記録を使用すると、電子メールやドキュメントが保護および使用された日時を特定できます。 RMS コネクタを使用してこれを実行すると、ログのユーザー ID フィールドには、RMS コネクタに自動的に作成されるサービス プリンシパル名 **Aadrm_S-1-7-0** が含まれます。

使用状況ログの詳細については、「[Azure Rights Management サービスの使用状況をログに記録して分析する](log-analyze-usage.md)」を参照してください。

診断のためにより詳細なログ記録が必要な場合は、Windows Sysinternals の [Debugview](http://go.microsoft.com/fwlink/?LinkID=309277) を使用し、IIS の既定のサイト用の web.config ファイルを変更して RMS コネクタに対するトレースを有効にすることができます。 このためには、次の操作を行います。

1. **%programfiles%\Microsoft Rights Management connector\Web Service** で web.config ファイルを探します。

2. 次の行を探します。

        <trace enabled="false" requestLimit="10" pageOutput="false" traceMode="SortByTime" localOnly="true"/>

3. 見つかった行を次の行に置き換えます。

        <trace enabled="true" requestLimit="10" pageOutput="false" traceMode="SortByTime" localOnly="true"/>

4.  IIS を停止してから起動し、トレースをアクティブ化します。 

5.  必要なトレースをキャプチャしたら、手順 3. の行を元に戻し、IIS を停止してから再起動します。




<!--HONumber=Nov16_HO5-->


